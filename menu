let state = "welcome";  
let fadeAmount = 0;  
let startButton, backButton;
let cardioButton, strengthButton;
let cardioDropdown, strengthDropdown;
let showCardio = false;
let showStrength = false;
let selectedWorkout = "";
let countdownTime = 0;  
let startTime = 0;  
let gradientImage;

function setup() {
  createCanvas(1000, 1000);
  textFont('Poppins');
  
  // Create buttons
  startButton = createStyledButton('Start', width / 2 - 75, height / 2 + 50, 150, 50, '24px');
  startButton.mousePressed(startGame);

  cardioButton = createStyledButton('Cardio', width / 2 - 100, 300, 250, 70, '28px');
  cardioButton.mousePressed(toggleCardioDropdown);
  cardioButton.hide();

  strengthButton = createStyledButton('Strength', width / 2 - 100, 400, 250, 70, '28px');
  strengthButton.mousePressed(toggleStrengthDropdown);
  strengthButton.hide();

  backButton = createStyledButton('Back', width / 2 - 50, height - 100, 100, 40, '20px');
  backButton.mousePressed(goBackToWorkoutMenu);
  backButton.hide();

  // Create dropdowns
  cardioDropdown = createSelect();
  cardioDropdown.position(width / 2 - 100, 370);
  cardioDropdown.option('Select your workout');
  cardioDropdown.option('15-min Run');
  cardioDropdown.option('30-min Run');
  cardioDropdown.changed(startSelectedCardio);
  cardioDropdown.hide();

  strengthDropdown = createSelect();
  strengthDropdown.position(width / 2 - 100, 470);
  strengthDropdown.option('Select your workout');
  strengthDropdown.option('1-min Push-Ups');
  strengthDropdown.option('1-min Planks');
  strengthDropdown.changed(startSelectedStrength);
  strengthDropdown.hide();

  // Pre-calculate and cache gradient
  gradientImage = createImage(width, height);
  drawGradient(gradientImage);
}

function draw() {
  if (state === "welcome") {
    drawWelcomeScreen();  
  } else if (state === "workout") {
    drawWorkoutMenu();  
  } else if (state === "countdown") {
    drawCountdown();  
  }
}

function drawWelcomeScreen() {
  background(173, 216, 230);  
  textAlign(CENTER);
  textSize(64);  
  textStyle(BOLD);  
  fill(0);  
  text('Welcome to FitQuest', width / 2, height / 2 - 100);  
}

function startGame() {
  state = "workout";  
  startButton.hide();  
  showWorkoutMenu();  
}

function drawWorkoutMenu() {
  image(gradientImage, 0, 0);
  fill(0);
  textSize(48);  
  textStyle(BOLD);  
  textAlign(CENTER);
  text('Select Your Workout', width / 2, 150);  
}

function showWorkoutMenu() {
  cardioButton.show();
  strengthButton.show();
}

function toggleCardioDropdown() {
  showCardio = !showCardio;
  cardioDropdown.style('display', showCardio ? 'block' : 'none');
  strengthDropdown.hide();
}

function toggleStrengthDropdown() {
  showStrength = !showStrength;
  strengthDropdown.style('display', showStrength ? 'block' : 'none');
  cardioDropdown.hide();
}

function startSelectedCardio() {
  let workout = cardioDropdown.value();
  if (workout === '15-min Run') {
    countdownTime = 15 * 60;  
  } else if (workout === '30-min Run') {
    countdownTime = 30 * 60;  
  }
  if (workout !== 'Select your workout') {
    startCountdown();
  }
}

function startSelectedStrength() {
  let workout = strengthDropdown.value();
  if (workout === '1-min Push-Ups' || workout === '1-min Planks') {
    countdownTime = 1 * 60;  
  }
  if (workout !== 'Select your workout') {
    startCountdown();
  }
}

function startCountdown() {
  state = "countdown";  
  startTime = millis();  
  cardioButton.hide();  
  strengthButton.hide();
  cardioDropdown.hide();
  strengthDropdown.hide();
  backButton.show();  
}

function drawCountdown() {
  background(173, 216, 230);  

  let timePassed = floor((millis() - startTime) / 1000);  
  let remainingTime = countdownTime - timePassed;  

  if (remainingTime <= 0) {
    remainingTime = 0;  
  }

  let minutes = floor(remainingTime / 60);
  let seconds = remainingTime % 60;
  let timeString = nf(minutes, 2) + ":" + nf(seconds, 2);

  textAlign(CENTER);
  textSize(128);  
  fill(0);  
  text(timeString, width / 2, height / 2);  

  if (remainingTime === 0) {
    setTimeout(() => {
      state = "workout";  
      showWorkoutMenu();  
      backButton.hide();  
    }, 1000);
  }
}

function goBackToWorkoutMenu() {
  state = "workout";
  showWorkoutMenu();
  backButton.hide();  
}

function drawGradient(img) {
  for (let i = 0; i <= img.height; i++) {
    let inter = map(i, 0, img.height, 0, 1);
    let c = lerpColor(color(173, 216, 230), color(138, 43, 226), inter);  
    img.loadPixels();
    for (let j = 0; j < img.width; j++) {
      let index = (j + i * img.width) * 4;
      img.pixels[index + 0] = red(c);
      img.pixels[index + 1] = green(c);
      img.pixels[index + 2] = blue(c);
      img.pixels[index + 3] = 255; // Alpha channel
    }
    img.updatePixels();
  }
}

// Helper function to create styled buttons
function createStyledButton(label, x, y, width, height, fontSize) {
  let button = createButton(label);
  button.position(x, y);
  button.size(width, height);
  button.style('font-size', fontSize);
  button.style('font-family', 'Poppins');
  button.style('background-color', '#ffffff');
  button.style('color', '#000000');
  return button;
}
